"use strict";(self["webpackChunkecopaw"]=self["webpackChunkecopaw"]||[]).push([[947],{9868:(e,t,a)=>{var n=a(46518),i=a(79504),s=a(91291),r=a(31240),o=a(72333),c=a(79039),l=RangeError,u=String,d=Math.floor,f=i(o),v=i("".slice),p=i(1..toFixed),k=function(e,t,a){return 0===t?a:t%2===1?k(e,t-1,a*e):k(e*e,t/2,a)},m=function(e){var t=0,a=e;while(a>=4096)t+=12,a/=4096;while(a>=2)t+=1,a/=2;return t},g=function(e,t,a){var n=-1,i=a;while(++n<6)i+=t*e[n],e[n]=i%1e7,i=d(i/1e7)},h=function(e,t){var a=6,n=0;while(--a>=0)n+=e[a],e[a]=d(n/t),n=n%t*1e7},L=function(e){var t=6,a="";while(--t>=0)if(""!==a||0===t||0!==e[t]){var n=u(e[t]);a=""===a?n:a+f("0",7-n.length)+n}return a},b=c((function(){return"0.000"!==p(8e-5,3)||"1"!==p(.9,0)||"1.25"!==p(1.255,2)||"1000000000000000128"!==p(0xde0b6b3a7640080,0)}))||!c((function(){p({})}));n({target:"Number",proto:!0,forced:b},{toFixed:function(e){var t,a,n,i,o=r(this),c=s(e),d=[0,0,0,0,0,0],p="",b="0";if(c<0||c>20)throw new l("Incorrect fraction digits");if(o!==o)return"NaN";if(o<=-1e21||o>=1e21)return u(o);if(o<0&&(p="-",o=-o),o>1e-21)if(t=m(o*k(2,69,1))-69,a=t<0?o*k(2,-t,1):o/k(2,t,1),a*=4503599627370496,t=52-t,t>0){g(d,0,a),n=c;while(n>=7)g(d,1e7,0),n-=7;g(d,k(10,n,1),0),n=t-1;while(n>=23)h(d,1<<23),n-=23;h(d,1<<n),g(d,1,1),h(d,2),b=L(d)}else g(d,0,a),g(d,1<<-t,0),b=L(d)+f("0",c);return c>0?(i=b.length,b=p+(i<=c?"0."+f("0",c-i)+b:v(b,0,i-c)+"."+v(b,i-c))):b=p+b,b}})},25947:(e,t,a)=>{a.r(t),a.d(t,{default:()=>ge});a(9868);var n=a(56768),i=a(24232),s={class:"carbon-reduction-page"},r={class:"calculator-container"},o={class:"nav-controls"},c={class:"back-to-home"},l={class:"switch-calculator"},u={class:"page-content"},d={key:0,class:"user-info-banner",ref:"userInfoCard"},f={class:"banner-content"},v={class:"user-section"},p={class:"user-name"},k={class:"metrics-section"},m={class:"metric-item"},g={class:"metric-icon"},h={class:"metric-data"},L={class:"metric-value count-up"},b={class:"metric-item"},C={class:"metric-icon"},y={class:"metric-data"},R={class:"metric-value count-up"};function w(e,t,a,w,x,A){var E=(0,n.g2)("CarbonReductionCalculator");return(0,n.uX)(),(0,n.CE)("div",s,[(0,n.Lk)("div",r,[(0,n.Lk)("div",o,[(0,n.Lk)("div",c,[(0,n.Lk)("button",{onClick:t[0]||(t[0]=function(){return A.goHome&&A.goHome.apply(A,arguments)}),class:"back-btn"},t[2]||(t[2]=[(0,n.Lk)("i",{class:"fas fa-home"},null,-1),(0,n.Lk)("span",null,"返回主页",-1)]))]),(0,n.Lk)("div",l,[(0,n.Lk)("button",{class:"switch-btn",onClick:t[1]||(t[1]=function(){return A.switchToEmissionCalculator&&A.switchToEmissionCalculator.apply(A,arguments)})},t[3]||(t[3]=[(0,n.Lk)("i",{class:"fas fa-exchange-alt"},null,-1),(0,n.eW)(" 切换到碳排放计算器 ")]))])]),(0,n.Lk)("div",u,[t[9]||(t[9]=(0,n.Lk)("h1",{class:"page-title"},"减碳计算器",-1)),t[10]||(t[10]=(0,n.Lk)("p",{class:"description"},"记录您的减碳行为，为环保贡献力量",-1)),x.isLoggedIn?((0,n.uX)(),(0,n.CE)("div",d,[t[8]||(t[8]=(0,n.Lk)("div",{class:"banner-glow"},null,-1)),(0,n.Lk)("div",f,[(0,n.Lk)("div",v,[t[4]||(t[4]=(0,n.Lk)("div",{class:"user-avatar"},[(0,n.Lk)("i",{class:"fas fa-user-circle pulse"}),(0,n.Lk)("div",{class:"avatar-ring"})],-1)),(0,n.Lk)("div",p,(0,i.v_)(x.username),1)]),(0,n.Lk)("div",k,[(0,n.Lk)("div",m,[(0,n.Lk)("div",g,[(0,n.Lk)("i",{class:(0,i.C4)(["fas fa-leaf",{"leaf-animation":!x.isRefreshing,"refresh-spin":x.isRefreshing}])},null,2)]),(0,n.Lk)("div",h,[(0,n.Lk)("div",L,(0,i.v_)(x.userCarbonReduction.toFixed(1)),1),t[5]||(t[5]=(0,n.Lk)("div",{class:"metric-label"},"kgCO₂e 减碳量",-1))])]),t[7]||(t[7]=(0,n.Lk)("div",{class:"metric-divider"},null,-1)),(0,n.Lk)("div",b,[(0,n.Lk)("div",C,[(0,n.Lk)("i",{class:(0,i.C4)(["fas fa-tree",{"tree-animation":!x.isRefreshing,"refresh-spin":x.isRefreshing}])},null,2)]),(0,n.Lk)("div",y,[(0,n.Lk)("div",R,(0,i.v_)(A.treeEquivalent),1),t[6]||(t[6]=(0,n.Lk)("div",{class:"metric-label"},"棵树等效",-1))])])])])],512)):(0,n.Q3)("",!0),(0,n.bF)(E,{onReductionSaved:A.onReductionSaved},null,8,["onReductionSaved"])])])])}var x=a(14048),A=a(30388),E=(a(51629),a(44114),a(23288),a(18111),a(7588),a(26099),a(78459),a(23500),a(76031),a(52675),a(89463),a(62010),a(45130)),I={class:"carbon-reduction-calculator"},_={class:"calculator-container"},S={class:"category-list"},F=["onClick"],T={class:"activity-list"},X=["onClick"],U={class:"activity-icon"},K={class:"activity-info"},$={class:"activity-factor"},N={class:"factor-value"},q={class:"calculation-panel"},M={class:"selected-activities"},O={key:0,class:"no-activities"},P={key:1,class:"activity-inputs"},W={class:"activity-header"},D=["onClick"],H={class:"input-group"},Q=["onUpdate:modelValue","placeholder"],j={class:"unit"},V={class:"reduction-amount"},z={class:"total-reduction"},B={class:"total-header"},J={class:"total-value"},G={class:"tree-equivalent"},Y=["disabled"],Z={key:0,class:"fas fa-save"},ee={key:1,class:"fas fa-spinner fa-spin"},te={key:0,class:"success-message success"},ae={key:1,class:"success-message error"},ne={class:"message-content"},ie={class:"message-detail"};function se(e,t,a,s,r,o){return(0,n.uX)(),(0,n.CE)("div",I,[(0,n.Lk)("div",_,[(0,n.Lk)("div",S,[((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(s.categories,(function(e){return(0,n.uX)(),(0,n.CE)("div",{key:e.id,class:(0,i.C4)(["category-item",{active:s.activeCategory===e.id}]),onClick:function(t){return s.setActiveCategory(e.id)}},[(0,n.Lk)("i",{class:(0,i.C4)(e.icon)},null,2),(0,n.Lk)("span",null,(0,i.v_)(e.name),1)],10,F)})),128))]),(0,n.Lk)("div",T,[((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(s.filteredActivities,(function(e){return(0,n.uX)(),(0,n.CE)("div",{key:e.id,class:(0,i.C4)(["activity-item",{selected:s.isActivitySelected(e.id)}]),onClick:function(t){return s.toggleActivity(e)}},[(0,n.Lk)("div",U,[(0,n.Lk)("i",{class:(0,i.C4)(e.icon)},null,2)]),(0,n.Lk)("div",K,[(0,n.Lk)("h3",null,(0,i.v_)(e.name),1),(0,n.Lk)("p",null,(0,i.v_)(e.description),1),(0,n.Lk)("div",$,[t[4]||(t[4]=(0,n.Lk)("span",null,"减碳系数：",-1)),(0,n.Lk)("span",N,(0,i.v_)(e.factor)+" kgCO₂e/"+(0,i.v_)(e.unit),1)])])],10,X)})),128))]),(0,n.Lk)("div",q,[(0,n.Lk)("div",M,[t[7]||(t[7]=(0,n.Lk)("h3",null,"已选减碳活动",-1)),0===s.selectedActivities.length?((0,n.uX)(),(0,n.CE)("div",O,t[5]||(t[5]=[(0,n.Lk)("i",{class:"fas fa-info-circle"},null,-1),(0,n.Lk)("p",null,"请从左侧选择减碳活动",-1)]))):((0,n.uX)(),(0,n.CE)("div",P,[((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(s.selectedActivities,(function(e){return(0,n.uX)(),(0,n.CE)("div",{key:e.id,class:"activity-input"},[(0,n.Lk)("div",W,[(0,n.Lk)("span",null,(0,i.v_)(e.name),1),(0,n.Lk)("button",{class:"remove-btn",onClick:function(t){return s.removeActivity(e.id)}},t[6]||(t[6]=[(0,n.Lk)("i",{class:"fas fa-times"},null,-1)]),8,D)]),(0,n.Lk)("div",H,[(0,n.bo)((0,n.Lk)("input",{type:"number","onUpdate:modelValue":function(t){return e.amount=t},placeholder:"输入"+e.unit,min:"0",onInput:t[0]||(t[0]=function(){return s.calculateTotalReduction&&s.calculateTotalReduction.apply(s,arguments)})},null,40,Q),[[E.Jo,e.amount]]),(0,n.Lk)("span",j,(0,i.v_)(e.unit),1)]),(0,n.Lk)("div",V," 减碳量："+(0,i.v_)((e.amount*e.factor).toFixed(2))+" kgCO₂e ",1)])})),128))]))]),(0,n.Lk)("div",z,[(0,n.Lk)("div",B,[t[8]||(t[8]=(0,n.Lk)("h3",null,"总减碳量",-1)),(0,n.Lk)("span",J,(0,i.v_)(s.totalReduction.toFixed(2))+" kgCO₂e",1)]),(0,n.Lk)("div",G,[t[9]||(t[9]=(0,n.Lk)("i",{class:"fas fa-tree"},null,-1)),(0,n.Lk)("span",null,"相当于种植了 "+(0,i.v_)((s.totalReduction/18).toFixed(1))+" 棵树",1)])]),(0,n.Lk)("button",{class:"save-btn",disabled:!s.canSave||s.isSaving,onClick:t[1]||(t[1]=function(){return s.saveReduction&&s.saveReduction.apply(s,arguments)})},[s.isSaving?((0,n.uX)(),(0,n.CE)("i",ee)):((0,n.uX)(),(0,n.CE)("i",Z)),(0,n.eW)(" "+(0,i.v_)(s.isSaving?"保存中...":"保存减碳记录"),1)],8,Y)])]),s.showSuccess?((0,n.uX)(),(0,n.CE)("div",te,[t[11]||(t[11]=(0,n.Lk)("i",{class:"fas fa-check-circle"},null,-1)),t[12]||(t[12]=(0,n.Lk)("div",{class:"message-content"},[(0,n.Lk)("div",{class:"message-title"},"减碳记录保存成功！")],-1)),(0,n.Lk)("button",{class:"close-message-btn",onClick:t[2]||(t[2]=function(e){return s.showSuccess=!1})},t[10]||(t[10]=[(0,n.Lk)("i",{class:"fas fa-times"},null,-1)]))])):(0,n.Q3)("",!0),s.showError?((0,n.uX)(),(0,n.CE)("div",ae,[t[15]||(t[15]=(0,n.Lk)("i",{class:"fas fa-exclamation-circle"},null,-1)),(0,n.Lk)("div",ne,[t[13]||(t[13]=(0,n.Lk)("div",{class:"message-title"},"保存失败",-1)),(0,n.Lk)("div",ie,(0,i.v_)(s.errorMessage),1)]),(0,n.Lk)("button",{class:"close-message-btn",onClick:t[3]||(t[3]=function(e){return s.showError=!1})},t[14]||(t[14]=[(0,n.Lk)("i",{class:"fas fa-times"},null,-1)]))])):(0,n.Q3)("",!0)])}var re=a(41034),oe=(a(28706),a(88431),a(2008),a(50113),a(48980),a(62062),a(72712),a(15086),a(54554),a(81148),a(22489),a(20116),a(61701),a(18237),a(13579),a(90144)),ce=a(60782),le=a(81387),ue=a(32674);const de={name:"CarbonReductionCalculator",emits:["reductionSaved"],setup:function(e,t){var a=t.emit,i=(0,ce.Pj)(),s=((0,le.rd)(),(0,oe.KR)(!1)),r=(0,oe.KR)(!1),o=(0,oe.KR)(""),c=(0,oe.KR)(!1),l=[{id:"transport",name:"交通出行",icon:"fas fa-car"},{id:"energy",name:"能源使用",icon:"fas fa-bolt"},{id:"food",name:"饮食选择",icon:"fas fa-utensils"},{id:"waste",name:"垃圾处理",icon:"fas fa-trash"},{id:"lifestyle",name:"生活方式",icon:"fas fa-heart"}],u=[{id:"bike",category:"transport",name:"骑自行车出行",description:"使用自行车代替机动车出行",icon:"fas fa-bicycle",factor:.2,unit:"公里"},{id:"public_transport",category:"transport",name:"乘坐公共交通",description:"使用公交、地铁等公共交通工具",icon:"fas fa-bus",factor:.1,unit:"公里"},{id:"walk",category:"transport",name:"步行出行",description:"选择步行代替其他交通方式",icon:"fas fa-walking",factor:.05,unit:"公里"},{id:"led_light",category:"energy",name:"使用LED灯",description:"使用LED节能灯泡",icon:"fas fa-lightbulb",factor:.02,unit:"小时"},{id:"solar_panel",category:"energy",name:"使用太阳能",description:"使用太阳能热水器或发电",icon:"fas fa-solar-panel",factor:.5,unit:"千瓦时"},{id:"vegetarian",category:"food",name:"素食饮食",description:"选择素食代替肉类",icon:"fas fa-leaf",factor:.3,unit:"餐"},{id:"local_food",category:"food",name:"本地食材",description:"选择本地生产的食材",icon:"fas fa-store",factor:.1,unit:"公斤"},{id:"recycle",category:"waste",name:"垃圾分类回收",description:"正确分类和回收垃圾",icon:"fas fa-recycle",factor:.15,unit:"公斤"},{id:"compost",category:"waste",name:"厨余堆肥",description:"将厨余垃圾进行堆肥处理",icon:"fas fa-seedling",factor:.2,unit:"公斤"},{id:"reusable_bag",category:"lifestyle",name:"使用环保袋",description:"使用可重复使用的购物袋",icon:"fas fa-shopping-bag",factor:.01,unit:"次"},{id:"reusable_bottle",category:"lifestyle",name:"使用环保水杯",description:"使用可重复使用的水杯",icon:"fas fa-glass-whiskey",factor:.02,unit:"次"}],d=(0,oe.KR)("transport"),f=(0,oe.KR)([]),v=(0,oe.KR)(0),p=(0,n.EW)((function(){return u.filter((function(e){return e.category===d.value}))})),k=function(e){d.value=e},m=function(e){return f.value.some((function(t){return t.id===e}))},g=function(e){var t=f.value.findIndex((function(t){return t.id===e.id}));-1===t?f.value.push((0,re.A)((0,re.A)({},e),{},{amount:0})):f.value.splice(t,1),L()},h=function(e){f.value=f.value.filter((function(t){return t.id!==e})),L()},L=function(){v.value=f.value.reduce((function(e,t){return e+t.amount*t.factor}),0)},b=(0,n.EW)((function(){return f.value.length>0&&f.value.every((function(e){return e.amount>0}))})),C=function(){var e=(0,A.A)((0,x.A)().mark((function e(){var t,n,l,u,d,p,k,m,g,h,L,C;return(0,x.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(b.value&&!c.value){e.next=2;break}return e.abrupt("return");case 2:if(c.value=!0,s.value=!1,r.value=!1,t=f.value.find((function(e){return!e.amount||isNaN(e.amount)||e.amount<=0})),!t){e.next=11;break}return r.value=!0,o.value="请为「".concat(t.name,"」输入有效的数量"),c.value=!1,e.abrupt("return");case 11:if(e.prev=11,n=f.value.map((function(e){return{id:e.id,name:e.name,amount:parseFloat(e.amount),reduction:parseFloat((e.amount*e.factor).toFixed(2))}})),console.log("发送减碳数据:",n),l=localStorage.getItem("token"),l){e.next=20;break}return r.value=!0,o.value="未登录或会话已过期，请重新登录",c.value=!1,e.abrupt("return");case 20:return console.log("请求开始，准备发送POST请求到:","/carbon/reduction"),e.prev=21,u=(0,ue.dw)(),console.log("API配置:",{baseURL:u.defaults.baseURL,timeout:u.defaults.timeout,headers:u.defaults.headers}),e.next=26,u.post("/carbon/reduction",{activities:n});case 26:d=e.sent,console.log("请求成功，服务器响应:",d.data),d.data&&d.data.success?(f.value=[],v.value=0,s.value=!0,p=d.data.data.newTotalReduction||0,console.log("新的减碳总量:",p),a("reductionSaved",p),setTimeout((0,A.A)((0,x.A)().mark((function e(){return(0,x.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,i.dispatch("updateUserCarbonReduction");case 3:return e.next=5,i.dispatch("syncLeaderboardWithCarbonReduction");case 5:console.log("已同步排名系统数据"),e.next=11;break;case 8:e.prev=8,e.t0=e["catch"](0),console.error("刷新数据失败:",e.t0);case 11:case"end":return e.stop()}}),e,null,[[0,8]])}))),1500)):(r.value=!0,o.value=(null===(k=d.data)||void 0===k?void 0:k.error)||"保存失败，请重试",console.error("保存失败，响应中没有success标志:",d.data)),e.next=35;break;case 31:throw e.prev=31,e.t0=e["catch"](21),console.error("API调用失败:",e.t0),e.t0;case 35:e.next=44;break;case 37:e.prev=37,e.t1=e["catch"](11),console.error("保存减碳记录失败:",e.t1),r.value=!0,L=(null===(m=e.t1.response)||void 0===m||null===(m=m.data)||void 0===m?void 0:m.error)||(null===(g=e.t1.response)||void 0===g||null===(g=g.data)||void 0===g?void 0:g.message),C=null===(h=e.t1.response)||void 0===h||null===(h=h.data)||void 0===h?void 0:h.details,L?(o.value=C?"".concat(L,": ").concat(C):L,console.error("服务器返回错误:",L,C)):e.t1.request?(o.value="服务器无响应，请检查网络连接",console.error("请求无响应:",e.t1.request)):(o.value="请求发送失败，请稍后重试",console.error("请求发送错误:",e.t1.message));case 44:return e.prev=44,c.value=!1,e.finish(44);case 47:case"end":return e.stop()}}),e,null,[[11,37,44,47],[21,31]])})));return function(){return e.apply(this,arguments)}}();return{categories:l,activeCategory:d,filteredActivities:p,selectedActivities:f,totalReduction:v,showSuccess:s,showError:r,errorMessage:o,isSaving:c,canSave:b,setActiveCategory:k,isActivitySelected:m,toggleActivity:g,removeActivity:h,calculateTotalReduction:L,saveReduction:C}}};var fe=a(71241);const ve=(0,fe.A)(de,[["render",se],["__scopeId","data-v-2fce110b"]]),pe=ve,ke={name:"CarbonReductionPage",components:{CarbonReductionCalculator:pe},data:function(){return{isLoggedIn:!1,username:"",userCarbonReduction:0,isRefreshing:!1}},computed:{treeEquivalent:function(){return Math.max(1,Math.round(this.userCarbonReduction/21))}},created:function(){var e=localStorage.getItem("token");e&&(this.isLoggedIn=!0,this.username=localStorage.getItem("username")||"环保达人",this.loadUserCarbonReduction())},mounted:function(){var e=this;setTimeout((function(){e.animationTriggered=!0,e.animateCountUp()}),500)},methods:{onReductionSaved:function(e){var t=this;if(console.log("收到子组件保存成功事件，新的总减碳量:",e),this.isRefreshing=!0,"number"===typeof e&&!isNaN(e)){this.userCarbonReduction;if(this.userCarbonReduction=e,this.$refs.userInfoCard)try{this.$refs.userInfoCard.classList.add("highlight-update"),setTimeout((function(){t.$refs.userInfoCard&&t.$refs.userInfoCard.classList.remove("highlight-update")}),2e3)}catch(a){console.error("无法添加/移除高亮动画类:",a)}}setTimeout((function(){t.loadUserCarbonReduction(!0)}),1e3)},animateCountUp:function(){var e=document.querySelectorAll(".count-up");e.forEach((function(e){var t=parseFloat(e.textContent),a=0,n=t/30,i=setInterval((function(){a+=n,a>=t&&(clearInterval(i),a=t),e.textContent=a.toFixed(1)}),30)}))},loadUserCarbonReduction:function(){var e=arguments,t=this;return(0,A.A)((0,x.A)().mark((function a(){var n,i,s,r,o,c;return(0,x.A)().wrap((function(a){while(1)switch(a.prev=a.next){case 0:if(n=e.length>0&&void 0!==e[0]&&e[0],a.prev=1,i=localStorage.getItem("token"),i){a.next=5;break}return a.abrupt("return");case 5:return s=(new Date).getTime(),a.next=8,fetch("http://localhost:5000/api/achievement/carbon-reduction?_t=".concat(s),{headers:{Authorization:"Bearer ".concat(i)},cache:"no-store"});case 8:if(r=a.sent,!r.ok){a.next=16;break}return a.next=12,r.json();case 12:if(o=a.sent,o&&"undefined"!==typeof o.carbon_reduction)if(c=parseFloat(o.carbon_reduction)||0,console.log("获取到的减碳总量:",c),n&&t.userCarbonReduction!==c){if(t.userCarbonReduction,t.userCarbonReduction=c,t.$refs.userInfoCard)try{t.$refs.userInfoCard.classList.add("highlight-update"),setTimeout((function(){t.$refs.userInfoCard&&t.$refs.userInfoCard.classList.remove("highlight-update")}),2e3)}catch(l){console.error("无法添加/移除高亮动画类:",l)}t.animateCountUp()}else n||(t.userCarbonReduction=c);a.next=18;break;case 16:console.error("获取减碳数据失败:",r.status,r.statusText);case 18:a.next=24;break;case 20:a.prev=20,a.t0=a["catch"](1),console.error("获取用户减碳数据失败:",a.t0),n||(t.userCarbonReduction=0);case 24:return a.prev=24,t.isRefreshing=!1,a.finish(24);case 27:case"end":return a.stop()}}),a,null,[[1,20,24,27]])})))()},switchToEmissionCalculator:function(){this.$router.push("/calculator")},goHome:function(){this.$router.push("/")}}},me=(0,fe.A)(ke,[["render",w],["__scopeId","data-v-3ced20b2"]]),ge=me}}]);
//# sourceMappingURL=947.67ed2593.js.map